const QUERY_SELECTOR = 'body > div > main > div > div > div.box > div:nth-child(4) > div.prices.mt-3 > div:nth-child(2) > div.w-100.my-1 > div > span';
const THEATER_SELECTOR = 'body > div > main > div > div > div.box > div:nth-child(4) > div:nth-child(4)';

function target_element() {
	// 劇場公演以外は除外
	const place = document.querySelector(THEATER_SELECTOR);
	if (!place) {
		return null;
	}
	if (!place.innerText) {
		return null;
	}
	if (!place.innerText.match(/HKT48劇場/)) {
		return null;
	}

	const el = document.querySelector(QUERY_SELECTOR);
	return el;
}

function seatNo_to_rect(n) {
	const rect_array = [
		[],
		[126, 55, 20, 14], // 1
		[147, 55, 20, 14], // 2
		[168, 55, 20, 14], // 3

		[229, 55, 20, 14], // 4
		[250, 55, 20, 14], // 5
		[270, 55, 20, 14], // 6
		[291, 55, 20, 14], // 7
		[312, 55, 20, 14], // 8
		[332, 55, 20, 14], // 9
		[352, 55, 20, 14], // 10
		[373, 55, 20, 14], // 11
		[394, 55, 20, 14], // 12

		[456, 55, 20, 14], // 13
		[477, 55, 20, 14], // 14
		[497, 55, 20, 14], // 15

		[ 85, 85, 20, 14], // 16
		[106, 85, 20, 14], // 17
		[126, 85, 20, 14], // 18
		[147, 85, 20, 14], // 19
		[168, 85, 20, 14], // 20

		[229, 85, 20, 14], // 21
		[250, 85, 20, 14], // 22
		[270, 85, 20, 14], // 23
		[291, 85, 20, 14], // 24
		[312, 85, 20, 14], // 25
		[332, 85, 20, 14], // 26
		[352, 85, 20, 14], // 27
		[373, 85, 20, 14], // 28
		[394, 85, 20, 14], // 29

		[456, 85, 20, 14], // 30
		[477, 85, 20, 14], // 31
		[497, 85, 20, 14], // 32
		[518, 85, 20, 14], // 33
		[538, 85, 20, 14], // 34

		[ 85, 115, 20, 15], // 35
		[106, 115, 20, 15], // 36
		[126, 115, 20, 15], // 37
		[147, 115, 20, 15], // 38
		[168, 115, 20, 15], // 39

		[229, 115, 20, 15], // 40
		[250, 115, 20, 15], // 41
		[270, 115, 20, 15], // 42
		[291, 115, 20, 15], // 43
		[312, 115, 20, 15], // 44
		[332, 115, 20, 15], // 45
		[352, 115, 20, 15], // 46
		[373, 115, 20, 15], // 47
		[394, 115, 20, 15], // 48

		[456, 115, 20, 15], // 49
		[477, 115, 20, 15], // 50
		[497, 115, 20, 15], // 51
		[518, 115, 20, 15], // 52
		[538, 115, 20, 15], // 53

		[ 85, 145, 20, 15], // 54
		[106, 145, 20, 15], // 55
		[126, 145, 20, 15], // 56
		[147, 145, 20, 15], // 57
		[168, 145, 20, 15], // 58

		[229, 145, 20, 15], // 59
		[250, 145, 20, 15], // 60
		[270, 145, 20, 15], // 61
		[291, 145, 20, 15], // 62
		[312, 145, 20, 15], // 63
		[332, 145, 20, 15], // 64
		[352, 145, 20, 15], // 65
		[373, 145, 20, 15], // 66
		[394, 145, 20, 15], // 67

		[456, 145, 20, 15], // 68
		[477, 145, 20, 15], // 69
		[497, 145, 20, 15], // 70
		[518, 145, 20, 15], // 71
		[538, 145, 20, 15], // 72

		[188, 190, 20, 15], // 73
		[209, 190, 20, 15], // 74
		[229, 190, 20, 15], // 75
		[250, 190, 20, 15], // 76
		[270, 190, 20, 15], // 77
		[291, 190, 20, 15], // 78
		[312, 190, 20, 15], // 79
		[332, 190, 20, 15], // 80
		[352, 190, 20, 15], // 81
		[373, 190, 20, 15], // 82
		[394, 190, 20, 15], // 83
		[414, 190, 20, 15], // 84
		[435, 190, 20, 15], // 85

		[497, 190, 20, 15], // 86

		[188, 221, 20, 15], // 87
		[209, 221, 20, 15], // 88
		[229, 221, 20, 15], // 89
		[250, 221, 20, 15], // 90
		[270, 221, 20, 15], // 91
		[291, 221, 20, 15], // 92
		[312, 221, 20, 15], // 93
		[332, 221, 20, 15], // 94
		[352, 221, 20, 15], // 95
		[373, 221, 20, 15], // 96
		[394, 221, 20, 15], // 97
		[414, 221, 20, 15], // 98
		[435, 221, 20, 15], // 99

		[497, 221, 20, 15], // 100
		[518, 221, 20, 15], // 101
		[538, 221, 20, 15], // 102

		[ 42, 251, 20, 15], // 103
		[ 64, 251, 20, 15], // 104
		[ 85, 251, 20, 15], // 105
		[106, 251, 20, 15], // 106
		[126, 251, 20, 15], // 107

		[188, 251, 20, 15], // 108
		[209, 251, 20, 15], // 109
		[229, 251, 20, 15], // 110
		[250, 251, 20, 15], // 111
		[270, 251, 20, 15], // 112
		[291, 251, 20, 15], // 113
		[312, 251, 20, 15], // 114
		[332, 251, 20, 15], // 115
		[352, 251, 20, 15], // 116
		[373, 251, 20, 15], // 117
		[394, 251, 20, 15], // 118
		[414, 251, 20, 15], // 119
		[435, 251, 20, 15], // 120

		[497, 251, 20, 15], // 121
		[518, 251, 20, 15], // 122
		[538, 251, 20, 15], // 123

		[ 42, 281, 20, 15], // 124
		[ 64, 281, 20, 15], // 125
		[ 85, 281, 20, 15], // 126
		[106, 281, 20, 15], // 127
		[126, 281, 20, 15], // 128

		[188, 281, 20, 15], // 129
		[209, 281, 20, 15], // 130
		[229, 281, 20, 15], // 131
		[250, 281, 20, 15], // 132
		[270, 281, 20, 15], // 133
		[291, 281, 20, 15], // 134
		[312, 281, 20, 15], // 135
		[332, 281, 20, 15], // 136
		[352, 281, 20, 15], // 137
		[373, 281, 20, 15], // 138
		[394, 281, 20, 15], // 139
		[414, 281, 20, 15], // 140
		[435, 281, 20, 15], // 141

		[497, 281, 20, 15], // 142
		[518, 281, 20, 15], // 143
		[538, 281, 20, 15], // 144

		[ 21, 312, 20, 15], // 145
		[ 42, 312, 20, 15], // 146
		[ 64, 312, 20, 15], // 147
		[ 85, 312, 20, 15], // 138
		[106, 312, 20, 15], // 149
		[126, 312, 20, 15], // 150

		[188, 312, 20, 15], // 151
		[209, 312, 20, 15], // 152
		[229, 312, 20, 15], // 153
		[250, 312, 20, 15], // 154
		[270, 312, 20, 15], // 155
		[291, 312, 20, 15], // 156
		[312, 312, 20, 15], // 157
		[332, 312, 20, 15], // 158
		[352, 312, 20, 15], // 159
		[373, 312, 20, 15], // 160
		[394, 312, 20, 15], // 161
		[414, 312, 20, 15], // 162
		[435, 312, 20, 15], // 163

		[497, 312, 20, 15], // 164
		[518, 312, 20, 15], // 165
		[538, 312, 20, 15], // 166

		[ 21, 341, 20, 15], // 167
		[ 42, 341, 20, 15], // 168
		[ 64, 341, 20, 15], // 169
		[ 85, 341, 20, 15], // 170
		[106, 341, 20, 15], // 171
		[126, 341, 20, 15], // 172

		[188, 341, 20, 15], // 173
		[209, 341, 20, 15], // 174
		[229, 341, 20, 15], // 175
		[250, 341, 20, 15], // 176
		[270, 341, 20, 15], // 177
		[291, 341, 20, 15], // 178
		[312, 341, 20, 15], // 179
		[332, 341, 20, 15], // 180
		[352, 341, 20, 15], // 181
		[373, 341, 20, 15], // 182
		[394, 341, 20, 15], // 183
		[414, 341, 20, 15], // 184
		[435, 341, 20, 15], // 185

		[497, 341, 20, 15], // 186
		[518, 341, 20, 15], // 187
		[538, 341, 20, 15], // 188
		[559, 341, 20, 15], // 189
		[579, 341, 20, 15], // 190
		[600, 341, 20, 15], // 191

		[ 21, 372, 20, 15], // 192
		[ 42, 372, 20, 15], // 193
		[ 64, 372, 20, 15], // 194
		[ 85, 372, 20, 15], // 195
		[106, 372, 20, 15], // 196
		[126, 372, 20, 15], // 197

		[188, 372, 20, 15], // 198
		[209, 372, 20, 15], // 199
		[229, 372, 20, 15], // 200
		[250, 372, 20, 15], // 201
		[270, 372, 20, 15], // 202
		[291, 372, 20, 15], // 203
		[312, 372, 20, 15], // 204
		[332, 372, 20, 15], // 205
		[352, 372, 20, 15], // 206
		[373, 372, 20, 15], // 207
		[394, 372, 20, 15], // 208
		[414, 372, 20, 15], // 209
		[435, 372, 20, 15], // 210

		[497, 372, 20, 15], // 211
		[518, 372, 20, 15], // 212
		[538, 372, 20, 15], // 213
		[559, 372, 20, 15], // 214
		[579, 372, 20, 15], // 215
		[600, 372, 20, 15], // 216

		[ 21, 402, 20, 15], // 217
		[ 42, 402, 20, 15], // 218
		[ 64, 402, 20, 15], // 219
		[ 85, 402, 20, 15], // 220
		[106, 402, 20, 15], // 221
		[126, 402, 20, 15], // 222

		[188, 402, 20, 15], // 223
		[209, 402, 20, 15], // 224
		[229, 402, 20, 15], // 225
		[250, 402, 20, 15], // 226
		[270, 402, 20, 15], // 227
		[291, 402, 20, 15], // 228
		[312, 402, 20, 15], // 229
		[332, 402, 20, 15], // 230
		[352, 402, 20, 15], // 231
		[373, 402, 20, 15], // 232
		[394, 402, 20, 15], // 233
		[414, 402, 20, 15], // 234
		[435, 402, 20, 15], // 235

		[497, 402, 20, 15], // 236
		[518, 402, 20, 15], // 237
		[538, 402, 20, 15], // 238
		[559, 402, 20, 15], // 239
		[579, 402, 20, 15], // 240
		[600, 402, 20, 15], // 241

		[ 21, 432, 20, 15], // 242
		[ 42, 432, 20, 15], // 243
		[ 64, 432, 20, 15], // 244
		[ 85, 432, 20, 15], // 245
		[106, 432, 20, 15], // 246
		[126, 432, 20, 15], // 247

		[188, 432, 20, 15], // 248
		[209, 432, 20, 15], // 249
		[229, 432, 20, 15], // 250
		[250, 432, 20, 15], // 251
		[270, 432, 20, 15], // 252
		[352, 432, 20, 15], // 253
		[373, 432, 20, 15], // 254
		[394, 432, 20, 15], // 255
		[414, 432, 20, 15], // 256
		[435, 432, 20, 15], // 257

		[497, 432, 20, 15], // 258
		[518, 432, 20, 15], // 259
		[538, 432, 20, 15], // 260
		[559, 432, 20, 15], // 261
		[579, 432, 20, 15], // 262

		[188, 463, 20, 15], // 263
		[209, 463, 20, 15], // 264
		[229, 463, 20, 15], // 265
		[250, 463, 20, 15], // 266
		[270, 463, 20, 15], // 267
		[352, 463, 20, 15], // 268
		[373, 463, 20, 15], // 269
		[394, 463, 20, 15], // 270
		[414, 463, 20, 15], // 271
		[435, 463, 20, 15], // 272

		[497, 463, 20, 15], // 273
		[538, 463, 20, 15], // 274
		[579, 463, 20, 15], // 275

		[497, 478, 20, 15], // 276
		[538, 478, 20, 15], // 277
		[579, 478, 20, 15], // 278

		[497, 493, 20, 15], // 279
		[538, 493, 20, 15], // 280
		[579, 493, 20, 15], // 281

		[497, 509, 20, 15], // 282
		[538, 509, 20, 15], // 283
		[579, 509, 20, 15], // 284
	];
	
	if (n >= 1 && n <= 284) {
		return rect_array[n];
	} else {
		return [0, 0, 0, 0];
	}
}

function display_seat() {
	const rect = seatNo_to_rect(this.seat_no);

	// オーバーレイ準備
	const overlay = document.createElement('div');
	overlay.style.zIndex = 1;
	overlay.style.position = 'fixed';
	overlay.style.left = 0;
	overlay.style.top = 0;
	overlay.style.width = '100%';
	overlay.style.height = '100%';
	overlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
	overlay.style.display = 'flex';
	overlay.style.justifyContent = 'center';
	overlay.style.alignItems = 'center';
	overlay.addEventListener('click', (evt) => {
		//evt.target.remove();
		overlay.remove();
	});

	// キャンバス準備
	const canvas = document.createElement('canvas');
	//canvas.style.width = '640px';
	//canvas.style.height = '541px';
	const ctx = canvas.getContext("2d");

	// 画像読み込み, 描画
	const img = new Image();
	img.addEventListener("load", () => {
		canvas.width = img.naturalWidth;
		canvas.height = img.naturalHeight;
		ctx.drawImage(img, 0, 0);

		// マーカー描画
		ctx.fillStyle = "rgb(255, 0, 0, 0.5)";
		ctx.fillRect(rect[0], rect[1], rect[2], rect[3]);
	});
	img.src = chrome.runtime.getURL('images/HKT48_Seat.png');
	overlay.appendChild(canvas);

	// 表示
	document.querySelector('body').appendChild(overlay);	
}

function parse_seat_no(s) {
	let ret = 0;	
	for (i = 0; i < s.length; i++) {
		c = s[i];
		n = null;
		switch(c) {
		case '０':
			n = 0;
			break;
		case '１':
			n = 1;
			break;
		case '２':
			n = 2;
			break;
		case '３':
			n = 3;
			break;
		case '４':
			n = 4;
			break;
		case '５':
			n = 5;
			break;
		case '６':
			n = 6;
			break;
		case '７':
			n = 7;
			break;
		case '８':
			n = 8;
			break;
		case '９':
			n = 9;
			break;
		}
		if (n !== null) {
			ret *= 10;
			ret += n;
		}
	}
	return ret;
}

function edit() {
	const el = target_element();
	if (!el) {
		return;
	}

	let seat_no = null;
	seat_no = parse_seat_no(el.innerText);

	el.style.textDecoration = 'underline';
	el.style.cursor = 'pointer';
	el.addEventListener('click', {handleEvent:display_seat, seat_no:seat_no});
	//console.log(seat_no);
}

edit();
